---
- name: Create Rancher cluster via API
  hosts: localhost
  gather_facts: false
  vars:
    rancher_url: "https://k8smanager.comtegra.pl"
    api_token: "token-p8htt:zmjjkpcfzb5gdrmq5djfsm4wrzszk9kb8fbqjpng9pvkmqm4fz762w"
    cluster_name: "k8-cluster"

  tasks:
    - name: Create cluster in Rancher
      uri:
        url: "{{ rancher_url }}/v1/provisioning.cattle.io.clusters"
        method: POST
        headers:
          Authorization: "Bearer {{ api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          metadata:
            name: "{{ cluster_name }}"
            namespace: "fleet-default"
          spec:
            kubernetesVersion: "v1.33.4+rke2r1"
            rkeConfig:
              machinePools: []
        validate_certs: false
        status_code: 201
      register: create_cluster_response

    - name: Show cluster creation response
      debug:
        var: create_cluster_response.json

    - name: Save cluster ID for future use
      set_fact:
        cluster_id: "{{ create_cluster_response.json.id }}"
      when: create_cluster_response.json.id is defined

    - name: Show cluster registration command
      debug:
        msg: "Cluster created successfully. ID: {{ cluster_id | default('Not available') }}"
